# Implementation Plan: System Tray Hotkeys

## Overview

Реализация системного трей-агента с поддержкой глобальных горячих клавиш и индикацией состояния. Компоненты включают State Machine для управления состояниями, Tray Manager для системного трея, Hotkey Manager для горячих клавиш, и систему индикации (визуальная + звуковая).

## Tasks

- [x] 1. Настройка проекта и базовой структуры
  - Инициализировать Go модуль для проекта Vox
  - Создать базовую структуру директорий (cmd/, internal/, pkg/, assets/)
  - Добавить зависимости: getlantern/systray, golang-design/hotkey, faiface/beep
  - Настроить логирование (использовать стандартную библиотеку log или популярный логгер)
  - _Requirements: 6.5_

- [ ] 2. Реализовать State Machine
  - [x] 2.1 Создать типы и интерфейсы для State Machine
    - Определить тип State (Idle, Recording, Processing)
    - Реализовать интерфейс StateMachine с методами GetState, Transition, Subscribe
    - Добавить валидацию переходов состояний (Idle→Recording→Processing→Idle)
    - _Requirements: 1.2, 2.2_
  
  - [ ]* 2.2 Написать property-тест для State Machine
    - **Property 1: Hotkey toggles state**
    - **Validates: Requirements 2.2**
  
  - [ ]* 2.3 Написать unit-тесты для State Machine
    - Тест конкретных переходов (Idle→Recording, Recording→Processing, Processing→Idle)
    - Тест невалидных переходов (Recording→Idle должен возвращать ошибку)
    - Тест механизма подписки на изменения состояния
    - _Requirements: 2.2_

- [ ] 3. Реализовать Hotkey Manager
  - [x] 3.1 Создать обертку над golang-design/hotkey
    - Определить типы Hotkey, Modifier, Key
    - Реализовать интерфейс HotkeyManager с методами Register, Unregister, UnregisterAll
    - Добавить обработку ошибок регистрации (если клавиша занята)
    - Реализовать корректную очистку при завершении
    - _Requirements: 2.1, 2.3, 2.4_
  
  - [ ]* 3.2 Написать property-тест для Hotkey Manager
    - **Property 2: Hotkey cleanup on shutdown**
    - **Validates: Requirements 2.4**
  
  - [ ]* 3.3 Написать unit-тесты для Hotkey Manager
    - Тест успешной регистрации горячей клавиши
    - Тест обработки занятой горячей клавиши (должен логировать и продолжать работу)
    - Тест отмены регистрации всех горячих клавиш
    - _Requirements: 2.3, 2.4_

- [x] 4. Checkpoint - Базовая функциональность
  - Убедиться, что все тесты проходят
  - Проверить, что State Machine корректно управляет переходами
  - Проверить, что Hotkey Manager корректно регистрирует и очищает горячие клавиши
  - Спросить пользователя, если возникли вопросы

- [ ] 5. Реализовать Visual Indicator
  - [x] 5.1 Создать компонент Visual Indicator
    - Реализовать интерфейс VisualIndicator с методом UpdateIcon
    - Подготовить заглушки для иконок (idle.png, recording.png, processing.png)
    - Реализовать загрузку иконок из assets/icons/
    - Добавить логику обновления иконки в зависимости от состояния
    - _Requirements: 3.1, 3.2, 3.3_
  
  - [ ]* 5.2 Написать property-тест для Visual Indicator
    - **Property 3: Icon reflects state**
    - **Validates: Requirements 3.1, 3.2, 3.3**
  
  - [ ]* 5.3 Написать property-тест для времени обновления иконки
    - **Property 4: Icon update responsiveness**
    - **Validates: Requirements 3.4**
  
  - [ ]* 5.4 Написать unit-тесты для Visual Indicator
    - Тест загрузки иконок из файлов
    - Тест обработки отсутствующих файлов иконок
    - Тест обновления иконки для каждого состояния
    - _Requirements: 3.1, 3.2, 3.3_

- [ ] 6. Реализовать Audio Indicator
  - [x] 6.1 Создать компонент Audio Indicator
    - Реализовать интерфейс AudioIndicator с методом PlaySound
    - Подготовить заглушки для звуковых файлов (start_recording.wav, stop_recording.wav, processing_done.wav)
    - Реализовать загрузку звуков из assets/sounds/
    - Интегрировать faiface/beep для воспроизведения WAV файлов
    - Добавить обработку ошибок воспроизведения (логировать и продолжать)
    - _Requirements: 4.1, 4.2, 4.3, 4.5_
  
  - [ ]* 6.2 Написать property-тест для Audio Indicator
    - **Property 5: Audio feedback duration limit**
    - **Validates: Requirements 4.4**
  
  - [ ]* 6.3 Написать unit-тесты для Audio Indicator
    - Тест загрузки звуковых файлов
    - Тест воспроизведения звука для каждого перехода состояния
    - Тест обработки отсутствующих звуковых файлов
    - _Requirements: 4.1, 4.2, 4.3_

- [ ] 7. Реализовать Indicator Manager
  - [x] 7.1 Создать координатор индикации
    - Реализовать интерфейс IndicatorManager с методами OnStateChange, SetVisualIndicator, SetAudioIndicator
    - Подписаться на изменения состояния из State Machine
    - При изменении состояния вызывать Visual Indicator и Audio Indicator
    - Обеспечить параллельное выполнение визуальной и звуковой индикации
    - _Requirements: 3.4, 4.1, 4.2, 4.3_
  
  - [ ]* 7.2 Написать unit-тесты для Indicator Manager
    - Тест координации визуальной и звуковой индикации
    - Тест обработки ошибок от индикаторов
    - Тест подписки на изменения состояния
    - _Requirements: 3.4, 4.1, 4.2, 4.3_

- [x] 8. Checkpoint - Система индикации
  - Убедиться, что все тесты проходят
  - Проверит��, что Visual Indicator корректно обновляет иконки
  - Проверить, что Audio Indicator корректно воспроизводит звуки
  - Проверить, что Indicator Manager корректно координирует индикацию
  - Спросить пользователя, если возникли вопросы

- [ ] 9. Реализовать Tray Manager
  - [x] 9.1 Создать обертку над getlantern/systray
    - Реализовать интерфейс TrayManager с методами Initialize, SetIcon, SetTooltip, Run, Quit
    - Создать контекстное меню с пунктами "Settings" (заглушка) и "Exit"
    - Обработать клик на "Exit" для корректного завершения приложения
    - Добавить обработку критических ошибок инициализации
    - _Requirements: 1.1, 1.3, 1.4, 1.5, 6.1_
  
  - [ ]* 9.2 Написать unit-тесты для Tray Manager
    - Тест создания иконки в трее (с моком systray)
    - Тест создания контекстного меню
    - Тест обработки клика на "Exit"
    - Тест корректного удаления иконки при завершении
    - _Requirements: 1.1, 1.3, 1.4, 1.5_

- [ ] 10. Интеграция компонентов
  - [x] 10.1 Создать главную функцию приложения
    - Инициализировать все компоненты в правильном порядке
    - Связать Hotkey Manager с State Machine (нажатие клавиши → переход состояния)
    - Связать State Machine с Indicator Manager (изменение состояния → индикация)
    - Связать Visual Indicator с Tray Manager (обновление иконки → SetIcon)
    - Настроить корректное завершение через defer (cleanup ресурсов)
    - _Requirements: 1.1, 1.2, 2.1, 2.2, 6.4_
  
  - [ ]* 10.2 Написать property-тест для cleanup ресурсов
    - **Property 6: Resource cleanup on critical error**
    - **Validates: Requirements 6.4**
  
  - [ ]* 10.3 Написать интеграционные тесты
    - Тест полного потока: нажатие горячей клавиши → изменение состояния → индикация
    - Тест корректного завершения приложения через меню "Exit"
    - Тест обработки критических ошибок с cleanup ресурсов
    - _Requirements: 1.1, 1.2, 2.2, 6.4_

- [ ] 11. Реализовать обработку ошибок и логирование
  - [x] 11.1 Добавить комплексное логирование
    - Логировать все критические ошибки с уровнем ERROR
    - Логировать некритические ошибки с уровнем WARN
    - Логировать информационные сообщения с уровнем INFO
    - Настроить запись логов в файл
    - _Requirements: 6.1, 6.2, 6.3, 6.5_
  
  - [ ]* 11.2 Написать property-тест для логирования
    - **Property 7: Error logging completeness**
    - **Validates: Requirements 6.5**
  
  - [ ]* 11.3 Написать unit-тесты для обработки ошибок
    - Тест критической ошибки инициализации трея (должен завершить приложение)
    - Тест некритической ошибки регистрации горячей клавиши (должен продолжить работу)
    - Тест предупреждения при ошибке воспроизведения звука (должен продолжить работу)
    - _Requirements: 6.1, 6.2, 6.3_

- [ ] 12. Создать ресурсы (иконки и звуки)
  - [x] 12.1 Подготовить иконки для трея
    - Создать idle.png (серая иконка микрофона, 16x16, 32x32, 64x64)
    - Создать recording.png (фиолетовая иконка микрофона, 16x16, 32x32, 64x64)
    - Создать processing.png (фиолетовая иконка с индикатором, 16x16, 32x32, 64x64)
    - Разместить иконки в assets/icons/
    - _Requirements: 3.1, 3.2, 3.3_
  
  - [x] 12.2 Подготовить звуковые файлы
    - Создать start_recording.wav (мягкий клик, <300ms)
    - Создать stop_recording.wav (мягкий клик, <300ms)
    - Создать processing_done.wav (мягкий клик, <300ms)
    - Разместить звуки в assets/sounds/
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 13. Checkpoint - Полная интеграция
  - Убедиться, что все тесты проходят
  - Проверить, что приложение корректно запускается и создает иконку в трее
  - Проверить, что горячая клавиша Alt+Shift+V переключает состояния
  - Проверить, что иконка меняется при переходах состояний
  - Проверить, что звуковые сигналы воспроизводятся при переходах
  - Проверить, что приложение корректно завершается через меню "Exit"
  - Спросить пользователя, если возникли вопросы

- [ ] 14. Кроссплатформенная поддержка
  - [x] 14.1 Настроить сборку для всех платформ
    - Создать Makefile или build скрипты для кроссплатформенной компиляции
    - Настроить сборку для Windows (x64, arm64)
    - Настроить сборку для Linux (x64, arm64) с musl для совместимости
    - Настроить сборку для macOS (x64, arm64)
    - _Requirements: 5.1, 5.2, 5.3_
  
  - [x] 14.2 Настроить GitHub Actions для CI/CD
    - Создать workflow для автоматической сборки на всех платформах
    - Настроить запуск тестов на Linux, Windows, macOS
    - Настроить публикацию артефактов через GitHub Releases
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [ ]* 14.3 Провести ручное тестирование на платформах
    - Протестировать на реальном Windows устройстве
    - Протестировать на реальном Linux устройстве
    - Протестировать на реальном macOS устройстве
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 15. Финальный checkpoint
  - Убедиться, что все тесты проходят на всех платформах
  - Проверить, что артефакты собираются корректно
  - Проверить, что приложение работает на всех целевых платформах
  - Проверить, что все требования выполнены
  - Спросить пользователя, если возникли вопросы

## Notes

- Задачи, помеченные `*`, являются опциональными и могут быть пропущены для быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property-тесты проверяют универсальные свойства корректности
- Unit-тесты проверяют конкретные примеры и граничные случаи
- Интеграционные тесты проверяют взаимодействие компонентов
- Все компоненты должны быть протестированы перед интеграцией
