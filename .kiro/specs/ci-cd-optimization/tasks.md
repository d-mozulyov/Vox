# Задачи по оптимизации CI/CD

## Статус: Готово к реализации

## Задачи

### 1. Создать Docker образ для сборки
**Статус**: Завершено ✓  
**Приоритет**: Высокий  
**Оценка**: 1 час

**Подзадачи**:
- [x] Создать директорию `docker/builder/`
- [x] Написать `Dockerfile` со всеми зависимостями
- [x] Создать `docker/builder/README.md` с инструкциями
- [x] Добавить `.dockerignore` если нужно

**Критерии приемки**:
- Dockerfile содержит все необходимые зависимости ✓
- Образ успешно собирается локально (требует проверки)
- Размер образа разумный (< 2GB) (требует проверки)

---

### 2. Собрать и опубликовать Docker образ
**Статус**: Не начато  
**Приоритет**: Высокий  
**Оценка**: 30 минут  
**Зависит от**: Задача 1

**Подзадачи**:
- [ ] Собрать образ локально в WSL
- [ ] Протестировать образ (запустить контейнер, проверить инструменты)
- [ ] Залогиниться в GitHub Container Registry
- [ ] Опубликовать образ в ghcr.io
- [ ] Проверить доступность образа

**Критерии приемки**:
- Образ доступен по адресу `ghcr.io/<username>/vox-builder:latest`
- Образ можно скачать без авторизации (публичный)
- Все инструменты работают в контейнере

---

### 3. Оптимизировать workflow для тестов
**Статус**: Завершено ✓  
**Приоритет**: Высокий  
**Оценка**: 30 минут  
**Зависит от**: Задача 2

**Подзадачи**:
- [x] Добавить `container:` в job `test`
- [x] Добавить кеширование Go модулей и сборки
- [x] Убрать шаги установки зависимостей
- [x] Обновить команду запуска тестов (Xvfb уже в образе)
- [ ] Протестировать на тестовой ветке (требует публикации образа)

**Критерии приемки**:
- Тесты проходят в Docker контейнере (требует проверки)
- Используется кеш Go ✓
- Время выполнения сократилось (требует проверки)

---

### 4. Оптимизировать workflow для сборки
**Статус**: Завершено ✓  
**Приоритет**: Высокий  
**Оценка**: 30 минут  
**Зависит от**: Задача 2

**Подзадачи**:
- [x] Добавить `container:` в job `build`
- [x] Добавить кеширование Go модулей и сборки
- [x] Убрать шаги установки musl-tools
- [x] Убрать скачивание aarch64-linux-musl-cross
- [x] Обновить PATH (компилятор уже в образе)
- [ ] Протестировать сборку всех платформ (требует публикации образа)

**Критерии приемки**:
- Сборка работает для всех 6 платформ (требует проверки)
- Используется кеш Go ✓
- Время выполнения сократилось (требует проверки)
- Бинарники корректные (требует проверки)

---

### 5. Создать workflow для обновления Docker образа (опционально)
**Статус**: Отменено (решено использовать ручное обновление)  
**Приоритет**: Низкий  
**Оценка**: 1 час

**Решение**: Вместо автоматического workflow используется ручная сборка и публикация через Docker CLI. Это проще, явнее и следует принципу KISS.

**Обоснование:**
- Dockerfile меняется редко (раз в несколько месяцев)
- Ручной процесс проще и понятнее
- Нет риска race condition между workflows
- Явный контроль над обновлением образа

---

### 6. Документировать процесс
**Статус**: Завершено ✓  
**Приоритет**: Средний  
**Оценка**: 30 минут

**Подзадачи**:
- [x] Обновить `BUILD.md` с информацией о Docker образе
- [x] Добавить инструкции по локальной сборке в Docker
- [x] Документировать процесс обновления образа
- [x] Добавить troubleshooting секцию

**Критерии приемки**:
- Документация понятна и полна ✓
- Описан процесс работы с Docker образом ✓
- Есть примеры команд ✓

---

### 7. Протестировать полный цикл
**Статус**: Не начато  
**Приоритет**: Высокий  
**Оценка**: 1 час  
**Зависит от**: Задачи 3, 4

**Подзадачи**:
- [ ] Создать тестовый тег
- [ ] Проверить прохождение тестов
- [ ] Проверить сборку всех платформ
- [ ] Проверить создание релиза
- [ ] Скачать и протестировать бинарники
- [ ] Замерить время выполнения

**Критерии приемки**:
- Весь pipeline работает корректно
- Время выполнения сократилось минимум в 2 раза
- Все артефакты корректны

---

## Порядок выполнения

1. Задача 1: Создать Dockerfile
2. Задача 2: Собрать и опубликовать образ
3. Задача 3: Оптимизировать тесты
4. Задача 4: Оптимизировать сборку
5. Задача 7: Протестировать
6. Задача 6: Документировать
7. Задача 5: (Опционально) Автоматизация обновления образа

## Общая оценка времени

- Обязательные задачи: ~4.5 часа
- Опциональные задачи: +1 час
- **Итого**: 4.5-5.5 часов

## Риски

- **Проблемы с WSL**: Может потребоваться настройка Docker в WSL
- **Права доступа**: Нужны права на публикацию в GitHub Container Registry
- **Размер образа**: Может быть больше ожидаемого, потребуется оптимизация

## Следующие шаги после завершения

1. Мониторить время выполнения CI/CD
2. При необходимости дополнительно оптимизировать
3. Рассмотреть кеширование Docker слоев
4. Возможно создать отдельный образ для тестов (легче)
