# Оптимизация CI/CD

## Проблема

Текущий GitHub Actions workflow очень медленный из-за:

1. Установка musl-tools и зависимостей занимает много времени на каждом запуске
2. Скачивание и распаковка aarch64-linux-musl-cross.tgz каждый раз
3. Отсутствие кеширования промежуточных файлов Go
4. Установка зависимостей для тестов также занимает время

## Цели оптимизации

1. **Создать Docker образ** со всеми предустановленными зависимостями:
   - Go 1.21+
   - musl-tools и musl-dev
   - aarch64-linux-musl-cross компилятор
   - Все Linux библиотеки (libasound2-dev, libx11-dev, и т.д.)
   - Xvfb для тестов

2. **Использовать кеширование Go**:
   - Кеш модулей Go (`go mod download`)
   - Кеш сборки Go (`~/.cache/go-build`)

3. **Оптимизировать workflow**:
   - Использовать собственный Docker образ вместо установки зависимостей
   - Добавить кеширование для ускорения повторных сборок
   - Параллелизация где возможно

## Требования

### Docker образ

- Базовый образ: `golang:1.21-alpine` или `ubuntu:22.04`
- Предустановленные инструменты:
  - musl-tools, musl-dev
  - aarch64-linux-musl-cross (распакован в /opt/)
  - Все необходимые dev-библиотеки
  - Xvfb для headless тестирования
- Публикация: GitHub Container Registry (ghcr.io)
- Тег: `ghcr.io/<username>/vox-builder:latest`

### Кеширование в GitHub Actions

- Кеш Go модулей: `~/.cache/go-build` и `~/go/pkg/mod`
- Ключ кеша: основан на `go.sum`
- Восстановление кеша при изменении зависимостей

### Workflow изменения

- Использовать `container:` для запуска jobs в Docker образе
- Добавить `actions/cache@v4` для Go кеша
- Убрать шаги установки зависимостей (они уже в образе)

## Инфраструктура

- **Сборка образа**: Может быть выполнена локально на Windows с WSL
- **Публикация**: GitHub Container Registry (бесплатно для публичных репозиториев)
- **Обновление**: При изменении зависимостей (редко)

## Ожидаемый результат

- Сокращение времени установки зависимостей с ~5-10 минут до ~10 секунд (pull образа)
- Ускорение повторных сборок благодаря кешу Go
- Упрощение workflow (меньше шагов)
- Воспроизводимость сборки (фиксированное окружение)

## Дополнительные улучшения

- Возможность локальной сборки в том же Docker образе
- Консистентность между CI и локальной разработкой
- Упрощение добавления новых зависимостей (обновить образ один раз)
